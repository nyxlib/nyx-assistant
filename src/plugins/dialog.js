// noinspection JSUnusedGlobalSymbols
/*--------------------------------------------------------------------------------------------------------------------*/

import * as notification from '@tauri-apps/plugin-notification';

import * as dialog from '@tauri-apps/plugin-dialog';

import * as fs from '@tauri-apps/plugin-fs';

/*--------------------------------------------------------------------------------------------------------------------*/
/* LOCK                                                                                                               */
/*--------------------------------------------------------------------------------------------------------------------*/

const _LOCKER_HTML = `
    <!-- *********************************************************************************************************** -->

    <div id="DEC2F4DE">
        <div class="align-self-center text-center">
            <div class="spinner-border" role="status" style="width: 4rem; height: 4rem;"></div>
            <div class="display-4" role="status">loadingâ€¦</div>
        </div>
    </div>

    <!-- *********************************************************************************************************** -->

    <style>
        /*------------------------------------------------------------------------------------------------------------*/

        #DEC2F4DE {
            /*--------------------------------------------------------------------------------------------------------*/

            display: none;
            justify-content: center;

            /*--------------------------------------------------------------------------------------------------------*/

            position: fixed;

            top: 40px;
            bottom: 00px;

            left: 0;
            right: 0;

            /*--------------------------------------------------------------------------------------------------------*/

            z-index: 9999;

            /*--------------------------------------------------------------------------------------------------------*/

            background-color: var(--bs-body-bg);

            /*--------------------------------------------------------------------------------------------------------*/
        }

        /*------------------------------------------------------------------------------------------------------------*/

        body[data-environment="tauri"][data-maximized="false"] > #DEC2F4DE {

            top: 41px !important;
            bottom: 01px !important;

            left: 01px !important;
            right: 01px !important;
        }

        /*------------------------------------------------------------------------------------------------------------*/
    </style>

    <!-- *********************************************************************************************************** -->
`;

/*--------------------------------------------------------------------------------------------------------------------*/

let _curLockCnt = 0;

/*--------------------------------------------------------------------------------------------------------------------*/

const _lock = () => {

    if(_curLockCnt <= 0)
    {
        document.getElementById('DEC2F4DE').style.display = 'flex';

        _curLockCnt = 1;
    }
    else
    {
        _curLockCnt++;
    }
}

/*--------------------------------------------------------------------------------------------------------------------*/

const _unlock = () => {

    if(_curLockCnt <= 1)
    {
        document.getElementById('DEC2F4DE').style.display = 'none';

        _curLockCnt = 0;
    }
    else
    {
        _curLockCnt--;
    }
};

/*--------------------------------------------------------------------------------------------------------------------*/
/* DIALOGS                                                                                                            */
/*--------------------------------------------------------------------------------------------------------------------*/

const _notify_step2 = (title, body) => {

    notification.sendNotification({
        title: title,
        body: body,
    });
};

/*--------------------------------------------------------------------------------------------------------------------*/

const _notify = (title, body) => {

    body = (body || '').trim();

    if(!body)
    {
        return;
    }

    /*----------------------------------------------------------------------------------------------------------------*/

    if(typeof window['__TAURI__'] !== 'undefined')
    {
        /*------------------------------------------------------------------------------------------------------------*/

        notification.isPermissionGranted().then((granted) => {

            if(!granted)
            {
                notification.requestPermission().then((result) => {

                    if(result === 'granted')
                    {
                        _notify_step2(title, body);
                    }
                });
            }
            else
            {
                _notify_step2(title, body);
            }
        });

        /*------------------------------------------------------------------------------------------------------------*/
    }
    else
    {
        /*------------------------------------------------------------------------------------------------------------*/

        alert(`${title}: ${body}`);

        /*------------------------------------------------------------------------------------------------------------*/
    }

    /*----------------------------------------------------------------------------------------------------------------*/

    console.log(`${title}: ${body}`);

    /*----------------------------------------------------------------------------------------------------------------*/
};

/*--------------------------------------------------------------------------------------------------------------------*/

const _success = (message) => {

    const el = document.querySelector('[data-tauri-drag-region]').closest('.navbar');

    if(el)
    {
        el.classList.remove('bg-primary');
        el.classList.add('bg-success');

        setTimeout(() => {

            el.classList.remove('bg-success');
            el.classList.add('bg-primary');

        }, 500);
    }

    _notify('Success', message);
    _unlock();

    return {then: () => {}};
};

/*--------------------------------------------------------------------------------------------------------------------*/

const _warning = (message) => {

    const el = document.querySelector('[data-tauri-drag-region]').closest('.navbar');

    if(el)
    {
        el.classList.remove('bg-primary');
        el.classList.add('bg-warning');

        setTimeout(() => {

            el.classList.remove('bg-warning');
            el.classList.add('bg-primary');

        }, 500);
    }

    _notify('Warning', message);
    _unlock();

    return {then: () => {}};
};

/*--------------------------------------------------------------------------------------------------------------------*/

const _error = (message) => {

    const el = document.querySelector('[data-tauri-drag-region]').closest('.navbar');

    if(el)
    {
        el.classList.remove('bg-primary');
        el.classList.add('bg-danger');

        setTimeout(() => {

            el.classList.remove('bg-danger');
            el.classList.add('bg-primary');

        }, 500);
    }

    _notify('Error', message);
    _unlock();

    return {then: () => {}};
};

/*--------------------------------------------------------------------------------------------------------------------*/

const _show = (message, title, type = null) => {

    if(typeof window['__TAURI__'] !== 'undefined')
    {
        /*------------------------------------------------------------------------------------------------------------*/

        dialog.message(message, {title: title, kind: type || 'error'}).catch((e) => {

            console.log(e);
        });

        /*------------------------------------------------------------------------------------------------------------*/
    }
    else
    {
        /*------------------------------------------------------------------------------------------------------------*/

        alert(message);

        /*------------------------------------------------------------------------------------------------------------*/
    }
};

/*--------------------------------------------------------------------------------------------------------------------*/

const _confirm = (message, title, type = null) => {

    return new Promise((resolve) => {

        if(typeof window['__TAURI__'] !== 'undefined')
        {
            /*--------------------------------------------------------------------------------------------------------*/

            dialog.confirm(message, {title: title, kind: type || 'info'}).then(resolve);

            /*--------------------------------------------------------------------------------------------------------*/
        }
        else
        {
            /*--------------------------------------------------------------------------------------------------------*/

            resolve(confirm(message));

            /*--------------------------------------------------------------------------------------------------------*/
        }
    });
};

/*--------------------------------------------------------------------------------------------------------------------*/

const _open = (defaultPath, typeMime, typeName, typeExts) => {

    return new Promise((resolve, reject) => {

        if(typeof window['__TAURI__'] !== 'undefined')
        {
            /*--------------------------------------------------------------------------------------------------------*/

            dialog.open({
                multiple: false,
                defaultPath: defaultPath,
                filters: [{
                    name: typeName,
                    extensions: typeExts,
                }]
            }).catch(reject).then((path) => {

                if(path)
                {
                    fs.readTextFile(path).catch(reject).then((text) => {

                        resolve([text, path]);
                    });
                }
                else
                {
                    reject('empty path');
                }
            });

            /*--------------------------------------------------------------------------------------------------------*/
        }
        else
        {
            /*--------------------------------------------------------------------------------------------------------*/

            const el = document.createElement('input');

            el.accept = typeExts.map((x) => `.${x}`).join(',');

            el.type = 'file';

            /*--------------------------------------------------------------------------------------------------------*/

            el.addEventListener('change', (e) => {

                /*----------------------------------------------------------------------------------------------------*/

                const file = e.target.files[0];

                if(file)
                {
                    const reader = new FileReader();

                    reader.onload = (e) => {

                        resolve([e.target.result, null]);
                    };

                    reader.onabort = reject;
                    reader.onerror = reject;

                    reader.readAsText(file);
                }
                else
                {
                    reject();
                }

                /*----------------------------------------------------------------------------------------------------*/

                document.body.removeChild(el);

                /*----------------------------------------------------------------------------------------------------*/
            });

            /*--------------------------------------------------------------------------------------------------------*/

            el.addEventListener('cancel', () => {

                /*----------------------------------------------------------------------------------------------------*/

                reject();

                /*----------------------------------------------------------------------------------------------------*/

                document.body.removeChild(el);

                /*----------------------------------------------------------------------------------------------------*/
            });

            /*--------------------------------------------------------------------------------------------------------*/

            document.body.appendChild(el);

            /*--------------------------------------------------------------------------------------------------------*/

            el.click();

            /*--------------------------------------------------------------------------------------------------------*/
        }
    });
};

/*--------------------------------------------------------------------------------------------------------------------*/

const _save = (defaultPath, typeMime, typeName, typeExts, contents) => {

    return new Promise((resolve, reject) => {

        if(typeof window['__TAURI__'] !== 'undefined')
        {
            /*--------------------------------------------------------------------------------------------------------*/

            dialog.save({
                defaultPath: defaultPath,
                filters: [
                    {
                        name: typeName,
                        extensions: typeExts,
                    },
                ],
            }).catch(reject).then((path) => {

                if(path)
                {
                    fs.writeTextFile(path, contents).catch(reject).then(() => {

                        resolve(path);
                    });
                }
                else
                {
                    reject('empty path');
                }

            });

            /*--------------------------------------------------------------------------------------------------------*/
        }
        else
        {
            /*--------------------------------------------------------------------------------------------------------*/

            const blob = new Blob([contents], {type: typeMime});

            const el = document.createElement('a');

            el.href = URL.createObjectURL(blob);
            el.download = defaultPath;
            el.style.display = 'none';

            document.body.appendChild(el);
            el.click();
            document.body.removeChild(el);

            resolve(null);

            /*--------------------------------------------------------------------------------------------------------*/
        }
    });
};

/*--------------------------------------------------------------------------------------------------------------------*/

export default {

    install(app)
    {
        /*------------------------------------------------------------------------------------------------------------*/

        document.body.innerHTML += _LOCKER_HTML;

        /*------------------------------------------------------------------------------------------------------------*/

        app.provide('dialog', {
            /* LOCKER */
            lock: _lock,
            unlock: _unlock,
            /* DIALOGS */
            notify: _notify,
            /**/
            success: _success,
            warning: _warning,
            error: _error,
            /**/
            show: _show,
            /**/
            confirm: _confirm,
            /**/
            open: _open,
            save: _save,
        });

        /*------------------------------------------------------------------------------------------------------------*/
    }
};

/*--------------------------------------------------------------------------------------------------------------------*/
