image: rust:latest

variables:
    NODE_VERSION: "0.40.0"

before_script:
    - apt-get update
    - apt-get install -y curl gdk-3.0 python3-dev python3-venv
    - python3 -m venv "${HOME}/.venv/"
    - source "${HOME}/.venv/bin/activate"
    - pip install pyinstaller

    - curl -o- "https://raw.githubusercontent.com/nvm-sh/nvm/v${NODE_VERSION}/install.sh" | bash
    - source "${HOME}/.nvm/nvm.sh"
    - nvm install 20

    - npm --version
    - node --version
    - rustc --version
    - python3 --version
    - pyinstaller --version

stages:
    - build_nyx_gen
    - build_nyx_assistant

build_nyx_gen_project:
    stage: build_nyx_gen
    script:
        - source "${HOME}/.venv/bin/activate"
        - ./gen/build.sh
    artifacts:
        paths:
            - tauri/binaries/nyx-gen-*
        expire_in: 1 week
        when: always
    only:
        - main

build_nyx_assistant_project:
    stage: build_nyx_assistant
    dependencies:
       - build_nyx_gen_project
    script:
        - source "${HOME}/.nvm/nvm.sh"
        - npm install
        - npm run tauri-prod
    artifacts:
        paths:
            - tauri/target/release/bundle/appimage/nyx-assistant_*.AppImage
        expire_in: 1 week
        when: always
    only:
        - main
